version: "3.9"

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: r2d2-backend:latest
    restart: unless-stopped
    ports:
      - "${R2D2_WEB_PORT:-5050}:5050"
    environment:
      R2D2_WEB_HOST: "0.0.0.0"
      R2D2_WEB_PORT: "${R2D2_WEB_PORT:-5050}"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY:-}"
      COMPILER_SERVICE_URL: "http://compiler:8080"
    volumes:
      - ./artifacts:/app/artifacts
      - ./data:/app/data
      - compile-volume:/compile
    depends_on:
      - compiler

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    image: r2d2-frontend:latest
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "${R2D2_FRONTEND_PORT:-5173}:5173"
    environment:
      VITE_R2D2_API_BASE: "http://backend:5050"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY:-}"

  compiler:
    build:
      context: .
      dockerfile: Dockerfile.compiler
    image: r2d2-compiler:latest
    restart: unless-stopped
    volumes:
      - compile-volume:/compile
    # Keep container running for exec-based compilation
    command: ["tail", "-f", "/dev/null"]
    user: compiler

volumes:
  compile-volume:
